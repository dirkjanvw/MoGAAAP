name: Build and Push Singularity Containers

# on:
#     push:
#         branches:
#             - main
#         paths:
#             - "workflow/singularity/**"
on: push

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout the code
              uses: actions/checkout@v3

            - name: Set up Skopeo
              run: sudo apt-get update && sudo apt-get install -y skopeo singularity-container

            # - name: Log in to GitHub Container Registry
            #   uses: docker/login-action@v2
            #   with:
            #       registry: ghcr.io
            #       username: ${{ github.actor }}
            #       password: ${{ secrets.GITHUB_TOKEN }}

            - name: Log in to GitHub Container Registry for ORAS
              run: |
                  echo "${{ secrets.GITHUB_TOKEN }}" | singularity remote login --token oras://ghcr.io

            - name: Build and Push Singularity Containers
              run: |
                  repo_name=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
                  cd workflow/singularity
                  for def_file in */*.def; do
                    container_name=$(basename "${def_file}" .def | tr '[:upper:]' '[:lower:]')
                    sudo singularity build "${container_name}.sif" "${def_file}"
                    sudo singularity push "${container_name}.sif" oras://ghcr.io/${repo_name}/${container_name}:latest
                  done
